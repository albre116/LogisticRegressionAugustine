---
title: "LogisticRegression"
author: "Mark Albrecht"
date: "November 22, 2015"
output: html_document
---

####Email text
Hi Scott,
I've updated the statistics in the white paper under **MA_edits.docx**.  The updates include:
-The statistics in the Table for all centers and the pooled result
-The statistics in the discussion for the updated McGovern numbers provided as provided in the text

For all of the statistics, I used a conservative model having a Haldane correction for sparse data across all analyses (this should take care of any p-values that you highlighted as possibly being too significant given the data at hand).  This tends to shrink the significance of the p-values and Odds-Ratios, so they are a bit less significant than the last analysis.  However, the results are still highly significant for 2 of the 3 centers and the overall pooled result.  

I think this is the best modeling approach (i.e. a conservative one) for the data you have, especially if you expect these results to be critically questioned down the road.  Also, I put all of this out on a github page so the next statistican can get up and running immediately.  The github page contains all of the statistical source code, so all you have to do is pass them this [link](https://github.com/albre116/LogisticRegressionAugustine) and they can pickup where I left off.  Since you are trying to publish this data, I'm assuming you don't care if someone can get at the source code (its public right now).  I can take it down the public github page if you want, but I'm anticipating what your needs are likely to be and this would make sense to me as it relates to getting someone else going to support your research.

I hope this helps you along with your efforts
best
mark


####Analysis Starts Here
Below is the analysis source code and data supporting the publication **Forced-air warming linked to periprosthetic total joint replacement infections**.  This is a R-markdown document, so it can be run directly in the R-Console to reproduce the results.

####Raw Data

The raw infection data by hospital is: 

```{r}
data <- data.frame(Hospital = c("Center1","Center1","Center2","Center2","Center3","Center3","Combined","Combined","PublicationRef","PublicationRef"),Device = c("CFW","FAW","CFW","FAW","CFW","FAW","CFW","FAW","CFW","FAW"),Infections = c(2,6,0,4,2,6,4,16,10,22),NonInfections = c(675,382,218,171,192,376,1085,929,1087,655))

summary(data)
```


The fitted models for each center and the pooled results are done using a Haldane correction, which corresponds to adding 1/2 a count to all cells prior to model fitting.  One can argue the proper correction method for sparse data, but the haldane add 1/2 psuedo count prior is one of the most common and, therefore, will be applied here to each center.  The reason we are applying a corrrection method across all of these center specific analyses and the pooled result, is that they have counts below 5 in one of the contingency table cells and as such are considered to be "sparse".  This is a conservative estimation method that will understate the odds and significance versus methods that assume no prior and use the exact counts.

```{r}
dataHaldane <- data
dataHaldane[,c("Infections","NonInfections")] <- dataHaldane[,c("Infections","NonInfections")] + 0.5

###group the counts
counts <- cbind(dataHaldane$Infections,dataHaldane$NonInfections)
hospitals <- c("Center1","Center2","Center3","Combined","PublicationRef")
i=1
models <- list()
null <- list()
result <- data.frame()
for(i in 1:length(hospitals)){
  center <- hospitals[i]
  idx <- dataHaldane$Hospital == center
  tmpdata <- dataHaldane[idx,]
  countstmp <- cbind(tmpdata$Infections,tmpdata$NonInfections)
  models[[i]] <- glm(countstmp~tmpdata$Device,family=binomial)
  null[[i]] <- glm(countstmp~1,family=binomial)
  #summary(models[[i]])
  #summary(null[[i]])
  Chisq <- anova(models[[i]],null[[i]],test="Chisq")
  print(Chisq)
  OR <- coef(models[[i]])[2]
  Variance <- vcov(models[[i]])[2,2]
  LCL <- OR + qnorm(0.05/2)*sqrt(Variance)
  UCL <- OR + qnorm(1-0.05/2)*sqrt(Variance)
  result <- rbind(result,data.frame(Hospital = center,
                                     Device = names(OR),
                                     LCL = exp(LCL),
                                     OR = exp(OR),
                                     UCL = exp(UCL),
                                     Pvalue= Chisq[2,5]))
  
}

print(result)
lapply(models,summary)


```





